!function t(e,i,n){function r(o,a){if(!i[o]){if(!e[o]){var c="function"==typeof require&&require;if(!a&&c)return c(o,!0);if(s)return s(o,!0);var h=new Error("Cannot find module '"+o+"'");throw h.code="MODULE_NOT_FOUND",h}var u=i[o]={exports:{}};e[o][0].call(u.exports,function(t){var i=e[o][1][t];return r(i?i:t)},u,u.exports,t,e,i,n)}return i[o].exports}for(var s="function"==typeof require&&require,o=0;o<n.length;o++)r(n[o]);return r}({1:[function(t,e,i){(function(n,r){i.Model=t("./model").createClass(),i.Collection=t("./collection").createClass(),i.createModelClass=t("./model").createClass,i.createCollectionClass=t("./collection").createClass,i.setVirtuals=t("./setVirtuals"),i.load=t("./load"),i.singleton=t("./singleton"),i.save=t("./save"),i.watchProperty=t("./watchProperty"),n.browser&&(r.Caplet=e.exports)}).call(this,t("_process"),"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./collection":2,"./load":3,"./model":4,"./save":5,"./setVirtuals":6,"./singleton":7,"./watchProperty":8,_process:9}],2:[function(t,e){function i(t){var e={};t||(t={}),"[object Array]"===Object.prototype.toString.call(t)?e.source=t:e=t,this.getInitialProperties&&(e=a({},this.getInitialProperties(),e)),n.call(this),this.setProperties(e),this.createModel=this.createModel.bind(this),this._onDataChange=this._onDataChange.bind(this),this._emitter=new r,s(this,"data",this._onDataChange).trigger(),this.watch(this._watchModels.bind(this)),this.initialize(),this.didChange&&this.watch(this.didChange.bind(this)),this._watchModels()}var n=t("watchable-collection"),r=t("fast-event-emitter"),s=t("./watchProperty"),o=t("./model").createClass(),a=t("xtend");n.extend(i,{modelClass:o,initialize:function(){},createModel:function(t){return new this.modelClass(t)},create:function(t){var e=this.createModel(t);return t.waitUntilSave||this.push(e),e},fromData:function(t){var e=this;return{source:(t||[]).map(function(t){return e.createModel({data:t})})}},toData:function(){return this.source},toJSON:function(){return this.toData()},_onDataChange:function(t){for(var e=this.fromData(t),i=e.source,n=this.source.concat(),r=i.length;r--;)for(var s=i[r],o=n.length;o--;){var a=n[o];if(s.equals(a)){a.set("data",s.toData()),i.splice(r,1,a);break}}this.setProperties(e)},_watchModels:function(){this._unwatchModels(),this._modelListeners=[];var t=this._onChange.bind(this);this.source.forEach(function(e){this._modelListeners.push(e.watch(t)),this._modelListeners.push(e._emitter.once("dispose",function(){this.splice(this.indexOf(e),1)}.bind(this)))}.bind(this))},_unwatchModels:function(){if(this._modelListeners){for(var t=this._modelListeners.length;t--;)this._modelListeners[t].dispose();this._modelListeners=void 0}}}),i.createClass=function(t){function e(t){return this instanceof i?void i.call(this,t):new e(t)}return i.extend(e,t),e},e.exports=i},{"./model":4,"./watchProperty":8,"fast-event-emitter":10,"watchable-collection":12,xtend:15}],3:[function(t,e){var i=t("./singleton");e.exports=function(t,e,n){i(t,"load",e,function(e,i){return e?n(e):(t.set("data",i),void n(null,t))})}},{"./singleton":7}],4:[function(t,e){function i(t){return"[object Object]"===Object.prototype.toString.call(t)}function n(t){t=i(t)?t:{data:t},this.getInitialProperties&&(t=a({},this.getInitialProperties(),t)),r.call(this,t),this._emitter=new s,o(this,"data",this._onDataChange.bind(this)).trigger(),this.initialize(),this.didChange&&this.watch(this.didChange.bind(this))}var r=t("watchable-object"),s=t("fast-event-emitter"),o=t("./watchProperty"),a=t("xtend");r.extend(n,{initialize:function(){},fromData:function(t){return i(t)?t:{}},toData:function(){var t={},e=this.data?this.data:this;if(!i(e))return e;for(var n in e)t[n]=e[n];return t},equals:function(t){return this.uid&&this.uid===t.uid||this.data===t.data},toJSON:function(){return this.toData()},_onDataChange:function(t){this.setProperties(this.fromData(t))},get:function(t){var e=r.prototype.get.call(this,t);if(void 0!=e)return e;var i=("string"==typeof t?t.split("."):t)[0];this._missingProperties||(this._missingProperties={}),this._missingProperties[i]||this._emitter.emit("missingProperty",this._missingProperties[i]=i)},dispose:function(){r.prototype.dispose.call(this),this._emitter.emit("dispose")}}),n.createClass=function(t){function e(t){return this instanceof n?void n.call(this,t):new e(t)}return n.extend(e,t),e},e.exports=n},{"./watchProperty":8,"fast-event-emitter":10,"watchable-object":14,xtend:15}],5:[function(t,e){e.exports=function(t,e,i){return t.uid?i.call(t):e.call(t)}},{}],6:[function(t,e){(function(i){var n=t("xtend");e.exports=function(t,e){return t.virtuals?n(t.virtuals,e):(t.virtuals=e,void t._emitter.on("missingProperty",function(e){e in t.virtuals&&t.virtuals[e].call(t,function(n,r){return n?t._emitter.emit("error",n):i.browser?void i.nextTick(function(){t.set(e,r)}):t.set(e,r)})}))}}).call(this,t("_process"))},{_process:9,xtend:15}],7:[function(t,e){e.exports=function(t,e,i,n){t._singletons||(t._singletons={});var r="singleton:"+e;t._emitter.once(r,n||function(){});var s;return(s=t._singletons[e])?s:(s={dispose:function(){t._singletons[e]=void 0}},t._singletons[e]=s,i(function(e,i){t._emitter.emit.apply(t._emitter,[r,e,i])}),s)}},{}],8:[function(t,e){e.exports=function(t,e,i){var n,r,s={trigger:function(){var r=t.get(e);n!==r&&(n=r,i(r,n))},dispose:function(){r.dispose()}};return r=t.watch(s.trigger),s}},{}],9:[function(t,e){function i(){if(!o){o=!0;for(var t,e=s.length;e;){t=s,s=[];for(var i=-1;++i<e;)t[i]();e=s.length}o=!1}}function n(){}var r=e.exports={},s=[],o=!1;r.nextTick=function(t){s.push(t),o||setTimeout(i,0)},r.title="browser",r.browser=!0,r.env={},r.argv=[],r.version="",r.versions={},r.on=n,r.addListener=n,r.once=n,r.off=n,r.removeListener=n,r.removeAllListeners=n,r.emit=n,r.binding=function(){throw new Error("process.binding is not supported")},r.cwd=function(){return"/"},r.chdir=function(){throw new Error("process.chdir is not supported")},r.umask=function(){return 0}},{}],10:[function(t,e){"use strict";function i(){this.__events={}}t("protoclass");i.prototype.on=function(t,e){if("function"!=typeof e)throw new Error("listener must be a function for event '"+t+"'");var i;(i=this.__events[t])?"function"==typeof i?this.__events[t]=[i,e]:i.push(e):this.__events[t]=e;var n=this;return{dispose:function(){n.off(t,e)}}},i.prototype.off=function(t,e){var i;if(i=this.__events[t])if("function"==typeof i)this.__events[t]=void 0;else{var n=i.indexOf(e);~n&&i.splice(n,1),i.length||(this.__events[t]=void 0)}},i.prototype.once=function(t,e){function i(){n.dispose(),e.apply(this,arguments)}if("function"!=typeof e)throw new Error("listener must be a function for event '"+t+"'");var n=this.on(t,i);return n.target=this,n},i.prototype.emit=function(t){if(void 0!==this.__events[t]){var e,i,n,r=this.__events[t],s=arguments.length;if("function"==typeof r)if(1===s)r();else switch(s){case 2:r(arguments[1]);break;case 3:r(arguments[1],arguments[2]);break;case 4:r(arguments[1],arguments[2],arguments[3]);break;default:for(e=new Array(s-1),i=1;s>i;i++)e[i-1]=arguments[i];r.apply(this,e)}else{for(e=new Array(s-1),i=1;s>i;i++)e[i-1]=arguments[i];for(n=r.length;n--;)r[n]&&r[n].apply(this,e)}}},i.prototype.removeAllListeners=function(t){1===arguments.length?this.__events[t]=void 0:this.__events={}},e.exports=i},{protoclass:11}],11:[function(t,e){function i(t,e){for(var i=0,n=e.length;n>i;i++){var r=e[i];for(var s in r)t[s]=r[s]}return t}function n(t,e){function r(){this.constructor=e}var s=Array.prototype.slice.call(arguments,2);return"function"!=typeof e&&(e&&s.unshift(e),e=t,t=function(){}),i(e,t),r.prototype=t.prototype,e.prototype=new r,e.__super__=t.prototype,e.parent=e.superclass=t,i(e.prototype,s),n.setup(e),e}n.setup=function(t){return t.extend||(t.extend=function(t){var e=Array.prototype.slice.call(arguments,0);return"function"!=typeof t&&e.unshift(t=function(){t.parent.apply(this,arguments)}),n.apply(this,[this].concat(e))},t.mixin=function(){i(this.prototype,arguments)},t.create=function(){var e=Object.create(t.prototype);return t.apply(e,arguments),e}),t},e.exports=n},{}],12:[function(t,e){function i(t){n.call(this),this.source=t||[],this.length=this.source.length;var e=this;r(this,"source",function(){e._onChange()}).trigger()}var n=t("watchable-object"),r=t("./watchProperty");n.extend(i,{at:function(t){return t<this.length?this.source[t]:void 0},map:function(t){return this.source.map(t)},filter:function(t){return this.source.filter(t)},forEach:function(t){return this.source.forEach(t)},join:function(t){return this.source.join(t)},pop:function(){return this.splice(this.source.length-1,1).pop()},shift:function(){return this.splice(0,1).pop()},push:function(){this.source.push.apply(this.source,arguments),this._onChange()},unshift:function(){this.source.unshift.apply(this.source,arguments),this._onChange()},indexOf:function(t){return this.source.indexOf(t)},splice:function(){var t=(Array.prototype.splice.apply(2,arguments),this.source.splice.apply(this.source,arguments));return this._onChange(),t},_onChange:function(){this.setProperties({length:this.source.length})}}),e.exports=i},{"./watchProperty":13,"watchable-object":14}],13:[function(t,e,i){arguments[4][8][0].apply(i,arguments)},{dup:8}],14:[function(t,e){function i(t){if(this.__watchable={},t)for(var e in t)this._watchProperty(e,this[e]=t[e])}var n=t("protoclass");n(i,{watch:function(t){this._listeners?"function"==typeof this._listeners?this._listeners=[this._listeners,t]:this._listeners.push(t):this._listeners=t;var e=this;return{dispose:function(){var i=0;e._listeners&&("function"!=typeof e._listeners&&~(i=e._listeners.indexOf(t))?(e._listeners.splice(i,1),0===e._listeners.length&&(e._listeners=void 0)):e._listeners=void 0)}}},get:function(t){var e;if((e="string"==typeof t)&&!~t.indexOf("."))return this[t];for(var i=e?t.split("."):t,n=this,r=0,s=i.length-1;s>r;r++){if(n=n[i[r]],!n)return;if(n.get)return n.get(t)}return n[i[r]]},set:function(t,e,i){var n;n="string"==typeof t?t.split("."):t;for(var r,s=this,o=(this.get(n)!==e,0),a=n.length-1;a>o;o++){if(r=s[n[o]],r&&r.set)return r.set(n.slice(o+1),e);r||(r=s[n[o]]={}),s=r}s[n[o]]=e,this._watchProperty(t,e),i!==!1&&this._triggerChange()},_watchProperty:function(t,e){if(e!==this)if(e&&e.watch){var i=this;this.__watchable[t]=e.watch(function(){return i.get(t)?void i._triggerChange():i._watchProperty(t,void 0)})}else{this.__watchable[t]&&this.__watchable[t].dispose(),this.__watchable[t]=void 0;var n=Object.prototype.toString.call(e);if("[object Object]"===n)for(var r in e)this._watchProperty(t+"."+r,e[r])}},setProperties:function(t){for(var e in t)this.set(e,t[e],!1);this._triggerChange()},_triggerChange:function(){if(!this._changing){if(this._changing=!0,this._listeners)if("function"==typeof this._listeners)this._listeners();else for(var t=this._listeners.length;t--;)this._listeners[t]();this._changing=!1}},dispose:function(){for(var t in this.__watchable)this.__watchable[t]&&this.__watchable[t].dispose();this.__watchable={},this._listeners=void 0}}),e.exports=i},{protoclass:11}],15:[function(t,e){function i(){for(var t={},e=0;e<arguments.length;e++){var i=arguments[e];for(var n in i)i.hasOwnProperty(n)&&(t[n]=i[n])}return t}e.exports=i},{}]},{},[1]);